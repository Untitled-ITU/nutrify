name: Auto Delete Merged Branches

on:
  push:
    branches:
      - develop
  pull_request:
    types: [closed]

jobs:
  delete-merged-branches:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Delete merged branches
        run: |
          # Get the current branch name
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          
          # If this is a PR merge to develop, get the source branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          else
            SOURCE_BRANCH=""
          fi
          
          # Function to check if branch should be deleted
          should_delete_branch() {
            local branch_name="$1"
            # Check if branch matches our patterns
            if [[ "$branch_name" =~ ^(feature|bugfix|infra)/.* ]]; then
              return 0
            fi
            return 1
          }
          
          # Function to check if branch is merged
          is_merged() {
            local branch_name="$1"
            local target_branch="$2"
            
            # Check if branch is merged into target branch
            if git merge-base --is-ancestor "$branch_name" "$target_branch" 2>/dev/null; then
              return 0
            fi
            return 1
          }
          
          # Get all remote branches
          git fetch --prune
          
          # List of branches to check for deletion
          branches_to_check=""
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # If this is a PR merge to develop, check the source branch
            if should_delete_branch "$SOURCE_BRANCH"; then
              branches_to_check="$SOURCE_BRANCH"
            fi
          else
            # If this is a direct push to develop, check all feature/bugfix/infra branches
            branches_to_check=$(git branch -r --merged develop | grep -E 'origin/(feature|bugfix|infra)/' | sed 's/origin\///' | grep -v '^develop$')
          fi
          
          # Delete branches that are merged and match our patterns
          for branch in $branches_to_check; do
            if should_delete_branch "$branch" && is_merged "$branch" "develop"; then
              echo "Deleting merged branch: $branch"
              
              # Delete remote branch
              if git push origin --delete "$branch" 2>/dev/null; then
                echo "âœ… Successfully deleted remote branch: $branch"
              else
                echo "âŒ Failed to delete remote branch: $branch"
              fi
            else
              echo "â­ï¸  Skipping branch: $branch (not merged or doesn't match pattern)"
            fi
          done
          
          echo "Branch cleanup completed!"

      - name: Summary
        run: |
          echo "## ðŸ§¹ Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "Automatically deleted merged feature/bugfix/infra branches from develop." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target branch:** develop" >> $GITHUB_STEP_SUMMARY
